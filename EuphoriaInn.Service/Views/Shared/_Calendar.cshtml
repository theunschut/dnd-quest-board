@using EuphoriaInn.Domain.Enums
@using EuphoriaInn.Domain.Interfaces
@using EuphoriaInn.Service.ViewModels.CalendarViewModels
@model CalendarViewModel
@{
    var isDetailsPage = ViewBag.IsDetailsPage == true;
    var currentQuestId = ViewBag.CurrentQuestId as int?;
}

<div class="calendar-grid @(isDetailsPage ? "details-page" : "") details-calendar-container">
    <!-- Calendar Header -->
    <div class="calendar-header">
        <div class="calendar-day-header">Monday</div>
        <div class="calendar-day-header">Tuesday</div>
        <div class="calendar-day-header">Wednesday</div>
        <div class="calendar-day-header">Thursday</div>
        <div class="calendar-day-header">Friday</div>
        <div class="calendar-day-header">Saturday</div>
        <div class="calendar-day-header">Sunday</div>
    </div>
    
    <!-- Calendar Days -->
    <div class="calendar-body">
        @foreach (var day in Model.GetCalendarDays())
        {
            <div class="calendar-day @(day.IsEmpty ? "empty" : "") @(day.Date.Date == DateTime.Today ? "today" : "")">
                @if (!day.IsEmpty)
                {
                    <div class="day-number">@day.Day</div>
                    
                    @if (day.QuestsOnDay.Any())
                    {
                        <div class="quest-events">
                            @foreach (var questOnDay in day.QuestsOnDay.Take(3))
                            {
                                <div class="quest-event @(questOnDay.IsFinalized ? "finalized" : "proposed") @(isDetailsPage && questOnDay.Quest.Id == currentQuestId ? "current-quest" : "")" 
                                     title="@questOnDay.Quest.Title - @questOnDay.ProposedDate.Date.ToString("HH:mm")"
                                     data-quest-id="@questOnDay.Quest.Id"
                                     data-proposed-date-id="@questOnDay.ProposedDate.Id"
                                     data-is-details-page="@isDetailsPage.ToString().ToLower()">
                                    <a href="@Url.Action("Details", "Quest", new { id = questOnDay.Quest.Id })"
                                       class="quest-link">
                                        <div class="calendar-quest-title">@questOnDay.Quest.Title</div>
                                        <div class="calendar-quest-dm">@questOnDay.Quest.DungeonMaster?.Name</div>
                                        <div class="quest-time">@questOnDay.ProposedDate.Date.ToString("HH:mm")</div>
                                    </a>

                                    @* Status icons (finalized/warning) - positioned outside the link *@
                                    @{
                                        var dmHasKey = questOnDay.Quest.DungeonMaster?.HasKey == true;
                                        var playersHaveKey = questOnDay.Quest.PlayerSignups?.Any(ps => ps.Player.HasKey == true) == true;
                                        var anyoneHasKey = dmHasKey || playersHaveKey;
                                    }
                                    @if (!anyoneHasKey)
                                    {
                                        <div class="warning-icon-display">
                                            <div class="status-indicator">
                                                <i class="fas fa-exclamation-triangle text-warning" title="No building key available"></i>
                                            </div>
                                        </div>
                                    }
                                    else if (questOnDay.IsFinalized)
                                    {
                                        <div class="finalized-icon-display">
                                            <div class="status-indicator">
                                                <i class="fas fa-check-circle text-success"></i>
                                            </div>
                                        </div>
                                    }

                                    @* Vote buttons and vote display *@
                                    @{
                                        var currentUserId = ViewBag.CurrentUserId;
                                        var userVote = questOnDay.ProposedDate.PlayerVotes?.FirstOrDefault(v => v.PlayerSignup?.Player?.Id == currentUserId)?.Vote;
                                    }

                                    @if (isDetailsPage && questOnDay.Quest.Id == currentQuestId)
                                    {
                                        var isPlayerSignedUp = ViewBag.IsPlayerSignedUp;
                                        var updateVoteIndexLookup = ViewData["UpdateVoteIndexLookup"] as Dictionary<int, int>;
                                        var isUpdateMode = updateVoteIndexLookup != null;

                                        @if (!questOnDay.IsFinalized && !(bool)isPlayerSignedUp)
                                        {
                                            @* Vote buttons for non-signed up users using proper form binding *@
                                            var voteIndexLookup = ViewBag.VoteIndexLookup as Dictionary<int, int>;
                                            var voteIndex = voteIndexLookup?.ContainsKey(questOnDay.ProposedDate.Id) == true
                                                ? voteIndexLookup[questOnDay.ProposedDate.Id]
                                                : -1;

                                            @if (voteIndex >= 0)
                                            {
                                                <div class="vote-buttons">
                                                    <div class="btn-group-vertical" role="group">
                                                        <input type="radio" class="btn-check" name="DateVotes[@voteIndex].Vote" id="vote_@(voteIndex)_yes" value="2" autocomplete="off">
                                                        <label class="btn btn-sm btn-outline-success" for="vote_@(voteIndex)_yes">
                                                            <i class="fas fa-check"></i>
                                                        </label>

                                                        <input type="radio" class="btn-check" name="DateVotes[@voteIndex].Vote" id="vote_@(voteIndex)_maybe" value="1" autocomplete="off">
                                                        <label class="btn btn-sm btn-outline-warning" for="vote_@(voteIndex)_maybe">
                                                            <i class="fas fa-question"></i>
                                                        </label>

                                                        <input type="radio" class="btn-check" name="DateVotes[@voteIndex].Vote" id="vote_@(voteIndex)_no" value="0" autocomplete="off">
                                                        <label class="btn btn-sm btn-outline-danger" for="vote_@(voteIndex)_no">
                                                            <i class="fas fa-times"></i>
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else if ((bool)isPlayerSignedUp && isUpdateMode)
                                        {
                                            @* Vote buttons for updating votes *@
                                            var updateVoteIndex = updateVoteIndexLookup?.ContainsKey(questOnDay.ProposedDate.Id) == true
                                                ? updateVoteIndexLookup[questOnDay.ProposedDate.Id]
                                                : -1;

                                            @if (updateVoteIndex >= 0)
                                            {
                                                var isCheckedYes = userVote.HasValue && userVote == VoteType.Yes;
                                                var isCheckedMaybe = userVote.HasValue && userVote == VoteType.Maybe;
                                                var isCheckedNo = userVote.HasValue && userVote == VoteType.No;

                                                <div class="vote-buttons">
                                                    <div class="btn-group-vertical" role="group">
                                                        <input type="radio" class="btn-check" name="DateVotes[@updateVoteIndex].Vote" id="update_vote_@(updateVoteIndex)_yes" value="2" autocomplete="off" @(isCheckedYes ? "checked" : "")>
                                                        <label class="btn btn-sm btn-outline-success" for="update_vote_@(updateVoteIndex)_yes">
                                                            <i class="fas fa-check"></i>
                                                        </label>

                                                        <input type="radio" class="btn-check" name="DateVotes[@updateVoteIndex].Vote" id="update_vote_@(updateVoteIndex)_maybe" value="1" autocomplete="off" @(isCheckedMaybe ? "checked" : "")>
                                                        <label class="btn btn-sm btn-outline-warning" for="update_vote_@(updateVoteIndex)_maybe">
                                                            <i class="fas fa-question"></i>
                                                        </label>

                                                        <input type="radio" class="btn-check" name="DateVotes[@updateVoteIndex].Vote" id="update_vote_@(updateVoteIndex)_no" value="0" autocomplete="off" @(isCheckedNo ? "checked" : "")>
                                                        <label class="btn btn-sm btn-outline-danger" for="update_vote_@(updateVoteIndex)_no">
                                                            <i class="fas fa-times"></i>
                                                        </label>
                                                    </div>
                                                </div>
                                            }
                                        }
                                        else if ((bool)isPlayerSignedUp)
                                        {
                                            @* Show user's vote for signed up users on details page *@
                                            <div class="user-vote-display">
                                                @{
                                                    var voteIcon = userVote switch
                                                    {
                                                        VoteType.Yes => "fas fa-check-circle text-success",
                                                        VoteType.Maybe => "fas fa-question-circle text-warning",
                                                        VoteType.No => "fas fa-times-circle text-danger",
                                                        _ => "fas fa-circle text-muted"
                                                    };
                                                    var voteText = userVote switch
                                                    {
                                                        VoteType.Yes => "Yes",
                                                        VoteType.Maybe => "Maybe",
                                                        VoteType.No => "No",
                                                        _ => "No Vote"
                                                    };
                                                }
                                                <div class="vote-indicator" title="Your vote: @voteText">
                                                    <i class="@voteIcon"></i>
                                                </div>
                                            </div>
                                        }
                                    }
                                    else if (!isDetailsPage && userVote.HasValue)
                                    {
                                        @* Show user's vote for all signed up quests on main calendar page *@
                                        <div class="user-vote-display">
                                            @{
                                                var voteIcon = userVote switch
                                                {
                                                    VoteType.Yes => "fas fa-check-circle text-success",
                                                    VoteType.Maybe => "fas fa-question-circle text-warning",
                                                    VoteType.No => "fas fa-times-circle text-danger",
                                                    _ => "fas fa-circle text-muted"
                                                };
                                                var voteText = userVote switch
                                                {
                                                    VoteType.Yes => "Yes",
                                                    VoteType.Maybe => "Maybe",
                                                    VoteType.No => "No",
                                                    _ => "No Vote"
                                                };
                                            }
                                            <div class="vote-indicator" title="Your vote: @voteText">
                                                <i class="@voteIcon"></i>
                                            </div>
                                        </div>
                                    }
                                </div>
                            }
                            @if (day.QuestsOnDay.Count > 3)
                            {
                                <div class="more-events">+@(day.QuestsOnDay.Count - 3) more</div>
                            }
                        </div>
                    }
                }
            </div>
        }
    </div>
</div>