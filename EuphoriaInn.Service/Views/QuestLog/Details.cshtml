@using EuphoriaInn.Service.ViewModels.QuestLogViewModels
@model QuestLogDetailsViewModel
@{
    ViewData["Title"] = $"Quest Log: {Model.Quest.Title}";
    var tokens = Antiforgery.GetAndStoreTokens(ViewContext.HttpContext);
}

<div class="row">
    <div class="col-md-8">
        <div class="card modern-card">
            <div class="card-header modern-card-header d-flex justify-content-between align-items-center">
                <h2 class="mb-0">@Model.Quest.Title</h2>
                <span class="badge cr-badge fs-6">
                    <i class="fas fa-dice-d20 me-1"></i>
                    CR @Model.Quest.ChallengeRating
                </span>
            </div>
            <div class="card-body modern-card-body">
                <!-- Quest Basic Info -->
                <div class="mb-4">
                    <h5 class="text-white"><i class="fas fa-info-circle me-2"></i>Quest Information</h5>
                    <div class="row text-white">
                        <div class="col-md-6">
                            <p class="text-white"><strong>Dungeon Master:</strong> @Model.Quest.DungeonMaster?.Name</p>
                            <p class="text-white"><strong>Challenge Rating:</strong> @Model.Quest.ChallengeRating</p>
                        </div>
                        <div class="col-md-6">
                            <p class="text-white"><strong>Completed On:</strong> @Model.Quest.FinalizedDate?.ToString("MMMM dd, yyyy 'at' h:mm tt")</p>
                            <p class="text-white"><strong>Created:</strong> @Model.Quest.CreatedAt.ToString("MMMM dd, yyyy")</p>
                        </div>
                    </div>
                </div>

                <hr />

                <!-- Original Quest Description -->
                <div class="mb-4">
                    <h5 class="text-white"><i class="fas fa-scroll me-2"></i>Original Quest Description</h5>
                    <div class="quest-description-box">
                        @Model.Quest.Description
                    </div>
                </div>

                <hr />

                <!-- Adventurers Who Participated -->
                <div class="mb-4">
                    <h5 class="text-white"><i class="fas fa-users me-2"></i>Adventurers</h5>
                    @{
                        var selectedPlayers = Model.Quest.PlayerSignups.Where(ps => ps.IsSelected).OrderBy(ps => ps.SignupTime).ToList();
                    }
                    @if (selectedPlayers.Any())
                    {
                        <div class="row">
                            @foreach (var player in selectedPlayers)
                            {
                                <div class="col-md-6 mb-2">
                                    <div class="player-badge">
                                        <i class="fas fa-user-shield me-2"></i>
                                        @player.Player.Name
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">No adventurers participated in this quest.</p>
                    }
                </div>

                <hr />

                <!-- Session Recap -->
                <div class="mb-4">
                    <h5 class="text-white"><i class="fas fa-book me-2"></i>Session Recap</h5>
                    
                    @if ((bool)ViewBag.CanEditRecap)
                    {
                        <form asp-action="UpdateRecap" asp-route-id="@Model.Quest.Id" method="post">
                            <div class="mb-3">
                                <label for="recap" class="form-label text-white">
                                    Write or update the session recap:
                                </label>
                                <textarea class="form-control" 
                                          id="recap" 
                                          name="recap" 
                                          rows="10" 
                                          placeholder="Describe what happened during this quest..."
                                          style="background-color: rgba(255, 255, 255, 0.95) !important; color: #1a1a1a !important; border: 2px solid #8B4513; font-weight: 500;">@Model.Quest.Recap</textarea>
                                <small class="form-text text-white">
                                    Share the story of this adventure with your players!
                                </small>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-2"></i>Save Recap
                            </button>
                        </form>
                    }
                    else
                    {
                        @if (!string.IsNullOrWhiteSpace(Model.Quest.Recap))
                        {
                            <div class="recap-display-box">
                                @Model.Quest.Recap
                            </div>
                        }
                        else
                        {
                            <p class="text-muted">No recap has been written for this quest yet.</p>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card modern-card mb-3">
            <div class="card-header modern-card-header">
                <h5 class="text-white mb-0">Quick Actions</h5>
            </div>
            <div class="card-body modern-card-body">
                <a href="@Url.Action("Index", "QuestLog")" class="btn btn-secondary w-100 mb-2">
                    <i class="fas fa-arrow-left me-2"></i>
                    Back to Quest Log
                </a>
                @if ((bool)ViewBag.CanEditRecap)
                {
                    <a href="@Url.Action("Manage", "Quest", new { id = Model.Quest.Id })" class="btn btn-info w-100">
                        <i class="fas fa-cog me-2"></i>
                        Manage Quest
                    </a>
                }
            </div>
        </div>

        <div class="card modern-card">
            <div class="card-header modern-card-header">
                <h5 class="text-white mb-0">Quest Statistics</h5>
            </div>
            <div class="card-body modern-card-body">
                <p class="text-white"><strong>Total Signups:</strong> @Model.Quest.PlayerSignups.Count</p>
                <p class="text-white"><strong>Participants:</strong> @selectedPlayers.Count / @Model.Quest.TotalPlayerCount</p>
                <p class="text-white">
                    <strong>Building Access:</strong>
                    @{
                        var dmHasKey = Model.Quest.DungeonMaster?.HasKey == true;
                        var playersHaveKey = Model.Quest.PlayerSignups?.Any(ps => ps.Player.HasKey == true) == true;
                        var anyoneHasKey = dmHasKey || playersHaveKey;
                    }
                    <span class="badge @(anyoneHasKey ? "bg-success" : "bg-danger")">
                        @if (anyoneHasKey)
                        {
                            <i class="fas fa-key me-1"></i>@:Available
                        }
                        else
                        {
                            <i class="fas fa-lock me-1"></i>@:No Key
                        }
                    </span>
                </p>
                <p class="text-white">
                    <strong>Status:</strong>
                    <span class="badge bg-dark">
                        <i class="fas fa-flag-checkered me-1"></i>
                        Completed
                    </span>
                </p>
            </div>
        </div>
    </div>
</div>
