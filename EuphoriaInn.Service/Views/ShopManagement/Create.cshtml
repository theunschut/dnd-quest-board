@using EuphoriaInn.Service.ViewModels.ShopViewModels
@model CreateShopItemViewModel
@{
    ViewData["Title"] = "Add New Shop Item";
}

<div class="container">
    <div class="card modern-card">
        <div class="card-header modern-card-header">
            <h2 class="mb-0">
                <i class="fas fa-plus text-success me-2"></i>
                Add New Shop Item
            </h2>
        </div>
        <div class="card-body modern-card-body">
            <form asp-action="Create" method="post">
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                
                <!-- Basic Information -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label asp-for="Name" class="form-label"></label>
                            <input asp-for="Name" class="form-control" placeholder="Enter item name..." />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label asp-for="Type" class="form-label"></label>
                            <select asp-for="Type" class="form-select">
                                <option value="">Select item type...</option>
                                <option value="Weapon">Weapon</option>
                                <option value="Armor">Armor</option>
                                <option value="Shield">Shield</option>
                                <option value="Accessory">Accessory (Ring, Amulet, etc.)</option>
                                <option value="Consumable">Consumable (Potion, Scroll, etc.)</option>
                                <option value="Tool">Tool</option>
                                <option value="MagicItem">Magic Item</option>
                            </select>
                            <span asp-validation-for="Type" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label asp-for="Description" class="form-label"></label>
                    <textarea asp-for="Description" class="form-control" rows="4" 
                              placeholder="Describe the item's appearance, properties, and lore..."></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                    <div class="form-text">Provide a detailed description including mechanical effects, appearance, and any lore.</div>
                </div>

                <!-- Rarity and Quantity -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="Rarity" class="form-label"></label>
                            <select asp-for="Rarity" class="form-select" onchange="updatePriceSuggestion()">
                                <option value="">Select rarity...</option>
                                <option value="Common">Common</option>
                                <option value="Uncommon">Uncommon</option>
                                <option value="Rare">Rare</option>
                                <option value="VeryRare">Very Rare</option>
                                <option value="Legendary">Legendary</option>
                            </select>
                            <span asp-validation-for="Rarity" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="Quantity" class="form-label"></label>
                            <input asp-for="Quantity" type="number" class="form-control" min="0" />
                            <span asp-validation-for="Quantity" class="text-danger"></span>
                            <div class="form-text">Set to 0 for unlimited stock</div>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="Price" class="form-label">Price (Gold Pieces)</label>
                            <div class="input-group">
                                <input asp-for="Price" type="number" class="form-control" min="0" step="0.01" />
                                <span class="input-group-text">gp</span>
                            </div>
                            <span asp-validation-for="Price" class="text-danger"></span>
                            <div class="form-text" id="price-suggestion">
                                Select a rarity to see pricing suggestions based on Tasha's Cauldron of Everything
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="ReferenceUrl" class="form-label"></label>
                            <input asp-for="ReferenceUrl" type="url" class="form-control" 
                                   placeholder="https://www.dndbeyond.com/..." />
                            <span asp-validation-for="ReferenceUrl" class="text-danger"></span>
                            <div class="form-text">Optional D&D Beyond link for reference</div>
                        </div>
                    </div>
                </div>

                <!-- Availability Window -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-info mb-3">
                            <i class="fas fa-clock me-2"></i>Availability Window (Optional)
                        </h5>
                        <p class="text-muted small">Set specific dates when this item should be available in the shop. Leave blank for permanent availability.</p>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="AvailableFrom" class="form-label"></label>
                            <input asp-for="AvailableFrom" type="datetime-local" class="form-control" />
                            <span asp-validation-for="AvailableFrom" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="AvailableUntil" class="form-label"></label>
                            <input asp-for="AvailableUntil" type="datetime-local" class="form-control" />
                            <span asp-validation-for="AvailableUntil" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Item Preview -->
                <div class="mb-4">
                    <h5 class="text-info mb-3">
                        <i class="fas fa-eye me-2"></i>Item Preview
                    </h5>
                    <div class="border rounded p-3 bg-light text-dark" id="item-preview">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0" id="preview-name">Item Name</h6>
                            <span class="badge bg-secondary" id="preview-rarity">Rarity</span>
                        </div>
                        <p class="text-muted small mb-2" id="preview-type">Item Type</p>
                        <p class="mb-2" id="preview-description">Item description will appear here...</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-warning" id="preview-price">0 gp</span>
                            <span class="text-muted small" id="preview-stock">Stock info</span>
                        </div>
                    </div>
                </div>

                <!-- Review Process Information -->
                <div class="alert alert-info mb-4">
                    <h6 class="alert-heading">
                        <i class="fas fa-info-circle me-2"></i>Review Process
                    </h6>
                    <p class="mb-2">Magic items and rare equipment require approval from other Dungeon Masters before appearing in the shop.</p>
                    <ul class="mb-0 small">
                        <li><strong>Common & Uncommon items:</strong> Available immediately</li>
                        <li><strong>Rare & Very Rare items:</strong> Require majority DM approval</li>
                        <li><strong>Legendary items:</strong> Require unanimous DM approval</li>
                    </ul>
                </div>

                <hr>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between">
                    <a href="/ShopManagement" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Cancel
                    </a>
                    <div>
                        <button type="button" class="btn btn-outline-info me-2" onclick="previewItem()">
                            <i class="fas fa-eye me-2"></i>Preview
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Item
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Price suggestions based on Tasha's Cauldron
        const pricingGuide = {
            'Common': { min: 50, max: 100, text: 'Common items typically cost 50-100 gp' },
            'Uncommon': { min: 101, max: 500, text: 'Uncommon items typically cost 101-500 gp' },
            'Rare': { min: 501, max: 5000, text: 'Rare items typically cost 501-5,000 gp' },
            'VeryRare': { min: 5001, max: 50000, text: 'Very Rare items typically cost 5,001-50,000 gp' },
            'Legendary': { min: 50001, max: 200000, text: 'Legendary items typically cost 50,001+ gp' }
        };

        function updatePriceSuggestion() {
            const rarity = document.getElementById('Rarity').value;
            const suggestionDiv = document.getElementById('price-suggestion');
            
            if (rarity && pricingGuide[rarity]) {
                const guide = pricingGuide[rarity];
                suggestionDiv.innerHTML = `<i class="fas fa-coins me-1"></i>${guide.text}`;
                suggestionDiv.className = 'form-text text-info';
                
                // Suggest a price in the middle of the range
                const suggestedPrice = Math.floor((guide.min + guide.max) / 2);
                document.getElementById('Price').value = suggestedPrice;
            } else {
                suggestionDiv.innerHTML = 'Select a rarity to see pricing suggestions based on Tasha\'s Cauldron of Everything';
                suggestionDiv.className = 'form-text';
            }
            
            updatePreview();
        }

        function updatePreview() {
            const name = document.getElementById('Name').value || 'Item Name';
            const type = document.getElementById('Type').value || 'Item Type';
            const rarity = document.getElementById('Rarity').value || 'Rarity';
            const description = document.getElementById('Description').value || 'Item description will appear here...';
            const price = document.getElementById('Price').value || '0';
            const quantity = document.getElementById('Quantity').value || '0';
            
            document.getElementById('preview-name').textContent = name;
            document.getElementById('preview-type').textContent = type;
            document.getElementById('preview-rarity').textContent = rarity.replace('VeryRare', 'Very Rare');
            document.getElementById('preview-description').textContent = description.length > 120 
                ? description.substring(0, 120) + '...' 
                : description;
            document.getElementById('preview-price').textContent = price + ' gp';
            
            const stockText = quantity == 0 ? 'Unlimited' : quantity + ' in stock';
            document.getElementById('preview-stock').textContent = stockText;
            
            // Update rarity badge styling
            const rarityBadge = document.getElementById('preview-rarity');
            rarityBadge.className = `badge rarity-${rarity.toLowerCase()}`;
        }

        function previewItem() {
            updatePreview();
            document.getElementById('item-preview').scrollIntoView({ behavior: 'smooth' });
        }

        // Auto-update preview as user types
        document.addEventListener('DOMContentLoaded', function() {
            const formInputs = ['Name', 'Type', 'Rarity', 'Description', 'Price', 'Quantity'];
            formInputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', updatePreview);
                    element.addEventListener('change', updatePreview);
                }
            });
            
            updatePreview();
        });

        // Form validation enhancement
        document.querySelector('form').addEventListener('submit', function(e) {
            const name = document.getElementById('Name').value.trim();
            const description = document.getElementById('Description').value.trim();
            const type = document.getElementById('Type').value;
            const rarity = document.getElementById('Rarity').value;
            
            if (!name || !description || !type || !rarity) {
                e.preventDefault();
                alert('Please fill in all required fields.');
                return false;
            }
            
            if (description.length < 20) {
                e.preventDefault();
                alert('Please provide a more detailed description (at least 20 characters).');
                return false;
            }
            
            return true;
        });
    </script>

    <style>
        .rarity-common { background-color: #6c757d !important; color: white !important; }
        .rarity-uncommon { background-color: #198754 !important; color: white !important; }
        .rarity-rare { background-color: #0d6efd !important; color: white !important; }
        .rarity-veryrare { background-color: #6f42c1 !important; color: white !important; }
        .rarity-legendary { 
            background: linear-gradient(45deg, #dc3545, #ffc107) !important; 
            color: white !important;
            animation: legendary-glow 2s ease-in-out infinite alternate;
        }
        
        @@keyframes legendary-glow {
            0% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.5); }
            100% { box-shadow: 0 0 15px rgba(255, 193, 7, 0.8); }
        }
        
        #item-preview {
            transition: all 0.3s ease;
        }
        
        #item-preview:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
    </style>
}