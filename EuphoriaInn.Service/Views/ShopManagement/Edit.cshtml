@using EuphoriaInn.Service.ViewModels.ShopViewModels
@model EditShopItemViewModel
@{
    ViewData["Title"] = "Edit Shop Item - " + Model.Name;
}

<div class="container">
    <div class="card modern-card">
        <div class="card-header modern-card-header">
            <h2 class="mb-0">
                <i class="fas fa-edit text-primary me-2"></i>
                Edit Shop Item
            </h2>
        </div>
        <div class="card-body modern-card-body">
            <form asp-action="Edit" method="post">
                <input asp-for="Id" type="hidden" />
                <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>
                
                <!-- Status Information -->
                <div class="alert alert-info mb-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="alert-heading mb-1">
                                <i class="fas fa-info-circle me-2"></i>Current Status
                            </h6>
                            <span class="badge @(Model.Status switch 
                            {
                                ItemStatus.Published => "bg-success",
                                ItemStatus.Draft => "bg-secondary", 
                                ItemStatus.Archived => "bg-secondary",
                                _ => "bg-secondary"
                            })">
                                @Model.Status.ToString().Replace("Published", "Available")
                            </span>
                            @if (Model.Status == ItemStatus.Draft)
                            {
                                <small class="text-muted ms-2">This item is awaiting DM approval</small>
                            }
                        </div>
                        <small class="text-muted">Item ID: #@Model.Id</small>
                    </div>
                </div>

                <!-- Basic Information -->
                <div class="row mb-4">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label asp-for="Name" class="form-label"></label>
                            <input asp-for="Name" class="form-control" />
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label asp-for="Type" class="form-label"></label>
                            <select asp-for="Type" class="form-select">
                                <option value="Equipment" selected="@(Model.Type == ItemType.Equipment)">Equipment</option>
                                <option value="MagicItem" selected="@(Model.Type == ItemType.MagicItem)">Magic Item</option>
                            </select>
                            <span asp-validation-for="Type" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-3">
                    <label asp-for="Description" class="form-label"></label>
                    <textarea asp-for="Description" class="form-control" rows="4"></textarea>
                    <span asp-validation-for="Description" class="text-danger"></span>
                </div>

                <!-- Rarity and Quantity -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="Rarity" class="form-label"></label>
                            <select asp-for="Rarity" class="form-select" onchange="updatePriceSuggestion()">
                                <option value="Common" selected="@(Model.Rarity == ItemRarity.Common)">Common</option>
                                <option value="Uncommon" selected="@(Model.Rarity == ItemRarity.Uncommon)">Uncommon</option>
                                <option value="Rare" selected="@(Model.Rarity == ItemRarity.Rare)">Rare</option>
                                <option value="VeryRare" selected="@(Model.Rarity == ItemRarity.VeryRare)">Very Rare</option>
                                <option value="Legendary" selected="@(Model.Rarity == ItemRarity.Legendary)">Legendary</option>
                            </select>
                            <span asp-validation-for="Rarity" class="text-danger"></span>
                            @if (Model.Status == ItemStatus.Draft)
                            {
                                <div class="form-text text-warning">
                                    <i class="fas fa-exclamation-triangle me-1"></i>
                                    Changes to rarity may require re-approval
                                </div>
                            }
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="Quantity" class="form-label"></label>
                            <input asp-for="Quantity" type="number" class="form-control" min="0" />
                            <span asp-validation-for="Quantity" class="text-danger"></span>
                            <div class="form-text">Set to 0 for unlimited stock</div>
                        </div>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="Price" class="form-label">Price (Gold Pieces)</label>
                            <div class="input-group">
                                <input asp-for="Price" type="number" class="form-control" min="0" step="0.01" />
                                <span class="input-group-text">gp</span>
                            </div>
                            <span asp-validation-for="Price" class="text-danger"></span>
                            <div class="form-text" id="price-suggestion">
                                Pricing suggestion will appear here
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="ReferenceUrl" class="form-label"></label>
                            <input asp-for="ReferenceUrl" type="url" class="form-control" />
                            <span asp-validation-for="ReferenceUrl" class="text-danger"></span>
                            <div class="form-text">Optional D&D Beyond link for reference</div>
                        </div>
                    </div>
                </div>

                <!-- Availability Window -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h5 class="text-info mb-3">
                            <i class="fas fa-clock me-2"></i>Availability Window (Optional)
                        </h5>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="AvailableFrom" class="form-label"></label>
                            <input asp-for="AvailableFrom" type="datetime-local" class="form-control" />
                            <span asp-validation-for="AvailableFrom" class="text-danger"></span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label asp-for="AvailableUntil" class="form-label"></label>
                            <input asp-for="AvailableUntil" type="datetime-local" class="form-control" />
                            <span asp-validation-for="AvailableUntil" class="text-danger"></span>
                        </div>
                    </div>
                </div>

                <!-- Item Preview -->
                <div class="mb-4">
                    <h5 class="text-info mb-3">
                        <i class="fas fa-eye me-2"></i>Item Preview
                    </h5>
                    <div class="border rounded p-3 bg-light text-dark" id="item-preview">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-0" id="preview-name">@Model.Name</h6>
                            <span class="badge bg-secondary" id="preview-rarity">@Model.Rarity.ToString().Replace("VeryRare", "Very Rare")</span>
                        </div>
                        <p class="text-muted small mb-2" id="preview-type">@Model.Type</p>
                        <p class="mb-2" id="preview-description">@Model.Description</p>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold text-warning" id="preview-price">@Model.Price gp</span>
                            <span class="text-muted small" id="preview-stock">@(Model.Quantity == 0 ? "Unlimited" : Model.Quantity + " in stock")</span>
                        </div>
                    </div>
                </div>

                <!-- Status Management -->
                @if (Model.Status != ItemStatus.Draft)
                {
                    <div class="mb-4">
                        <h5 class="text-warning mb-3">
                            <i class="fas fa-cogs me-2"></i>Status Management
                        </h5>
                        <div class="row">
                            <div class="col-md-6">
                                <label for="Status" class="form-label">Item Status</label>
                                <select asp-for="Status" class="form-select">
                                    <option value="Available" selected="@(Model.Status == ItemStatus.Published)">Available</option>
                                    <option value="Discontinued" selected="@(Model.Status == ItemStatus.Archived)">Discontinued</option>
                                </select>
                            </div>
                            <div class="col-md-6 d-flex align-items-end">
                                @if (Model.Rarity >= ItemRarity.Rare && Model.Type == ItemType.MagicItem)
                                {
                                    <button type="button" class="btn btn-warning" onclick="submitForReview()">
                                        <i class="fas fa-paper-plane me-2"></i>Submit for Review
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                }

                <!-- Warning for review items -->
                @if (Model.Status == ItemStatus.Draft)
                {
                    <div class="alert alert-warning mb-4">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>Item Under Review
                        </h6>
                        <p class="mb-0">This item is currently being reviewed by other Dungeon Masters. Major changes may require re-approval.</p>
                    </div>
                }

                <hr>

                <!-- Form Actions -->
                <div class="d-flex justify-content-between">
                    <a href="/ShopManagement" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Management
                    </a>
                    <div>
                        <a href="/ShopManagement/Details/@Model.Id" class="btn btn-outline-info me-2">
                            <i class="fas fa-eye me-2"></i>View Details
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Price suggestions based on Tasha's Cauldron
        const pricingGuide = {
            'Common': { min: 50, max: 100, text: 'Common items typically cost 50-100 gp' },
            'Uncommon': { min: 101, max: 500, text: 'Uncommon items typically cost 101-500 gp' },
            'Rare': { min: 501, max: 5000, text: 'Rare items typically cost 501-5,000 gp' },
            'VeryRare': { min: 5001, max: 50000, text: 'Very Rare items typically cost 5,001-50,000 gp' },
            'Legendary': { min: 50001, max: 200000, text: 'Legendary items typically cost 50,001+ gp' }
        };

        function updatePriceSuggestion() {
            const rarity = document.getElementById('Rarity').value;
            const suggestionDiv = document.getElementById('price-suggestion');
            
            if (rarity && pricingGuide[rarity]) {
                const guide = pricingGuide[rarity];
                suggestionDiv.innerHTML = `<i class="fas fa-coins me-1"></i>${guide.text}`;
                suggestionDiv.className = 'form-text text-info';
            } else {
                suggestionDiv.innerHTML = 'Select a rarity to see pricing suggestions';
                suggestionDiv.className = 'form-text';
            }
            
            updatePreview();
        }

        function updatePreview() {
            const name = document.getElementById('Name').value || 'Item Name';
            const type = document.getElementById('Type').value || 'Item Type';
            const rarity = document.getElementById('Rarity').value || 'Rarity';
            const description = document.getElementById('Description').value || 'Item description...';
            const price = document.getElementById('Price').value || '0';
            const quantity = document.getElementById('Quantity').value || '0';
            
            document.getElementById('preview-name').textContent = name;
            document.getElementById('preview-type').textContent = type;
            document.getElementById('preview-rarity').textContent = rarity.replace('VeryRare', 'Very Rare');
            document.getElementById('preview-description').textContent = description.length > 120 
                ? description.substring(0, 120) + '...' 
                : description;
            document.getElementById('preview-price').textContent = price + ' gp';
            
            const stockText = quantity == 0 ? 'Unlimited' : quantity + ' in stock';
            document.getElementById('preview-stock').textContent = stockText;
            
            // Update rarity badge styling
            const rarityBadge = document.getElementById('preview-rarity');
            rarityBadge.className = `badge rarity-${rarity.toLowerCase()}`;
        }

        function submitForReview() {
            if (confirm('Are you sure you want to submit this item for review? It will become unavailable until approved by other DMs.')) {
                fetch(`/ShopManagement/SubmitForReview/@Model.Id`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('Item submitted for review successfully!');
                        location.reload();
                    } else {
                        alert('Submit failed: ' + (data.message || 'Unknown error'));
                    }
                })
                .catch(error => {
                    console.error('Error submitting for review:', error);
                    alert('Submit failed. Please try again.');
                });
            }
        }

        // Auto-update preview as user types
        document.addEventListener('DOMContentLoaded', function() {
            const formInputs = ['Name', 'Type', 'Rarity', 'Description', 'Price', 'Quantity'];
            formInputs.forEach(inputId => {
                const element = document.getElementById(inputId);
                if (element) {
                    element.addEventListener('input', updatePreview);
                    element.addEventListener('change', updatePreview);
                }
            });
            
            // Initialize
            updatePriceSuggestion();
            updatePreview();
        });

        // Form validation
        document.querySelector('form').addEventListener('submit', function(e) {
            const name = document.getElementById('Name').value.trim();
            const description = document.getElementById('Description').value.trim();
            
            if (!name || !description) {
                e.preventDefault();
                alert('Please fill in all required fields.');
                return false;
            }
            
            if (description.length < 20) {
                e.preventDefault();
                alert('Please provide a more detailed description (at least 20 characters).');
                return false;
            }
            
            return true;
        });
    </script>

    <style>
        .rarity-common { background-color: #6c757d !important; color: white !important; }
        .rarity-uncommon { background-color: #198754 !important; color: white !important; }
        .rarity-rare { background-color: #0d6efd !important; color: white !important; }
        .rarity-veryrare { background-color: #6f42c1 !important; color: white !important; }
        .rarity-legendary { 
            background: linear-gradient(45deg, #dc3545, #ffc107) !important; 
            color: white !important;
            animation: legendary-glow 2s ease-in-out infinite alternate;
        }
        
        @@keyframes legendary-glow {
            0% { box-shadow: 0 0 5px rgba(220, 53, 69, 0.5); }
            100% { box-shadow: 0 0 15px rgba(255, 193, 7, 0.8); }
        }
    </style>
    </script>
}